<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desafio da Sa√∫de 3.0 - 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .custom-select {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236B7280%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22/%3E%3C/svg%3E');
            background-repeat: no-repeat; background-position: right 0.7rem center; background-size: 0.65rem auto;
        }
        .subtle-bg {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='49' viewBox='0 0 28 49'%3E%3Cg fill-rule='evenodd'%3E%3Cg id='hexagons' fill='%23e2f3f1' fill-opacity='0.4' fill-rule='nonzero'%3E%3Cpath d='M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9v12.7l10.99 6.34 11-6.35V17.9l-11-6.34L3 17.9zM0 15l12.99-7.5L26 15v18.5L13 41 0 33.5V15z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        #thank-you-screen {
            background-image: url('imagens/tela_final.png');
            background-color: #f0fdfa;
            background-size: cover;
            background-position: center;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app-container" class="container mx-auto p-4 sm:p-6 max-w-5xl">
        <div id="loading-screen" class="text-center p-10">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-gray-600">Conectando ao servidor...</p>
        </div>

        <div id="setup-screen" class="hidden">
            <header class="text-center mb-6 max-w-md mx-auto">
                <img src="imagens/logo_desafio.png" alt="Logo Desafio" class="mx-auto w-32 md:w-40 mb-4 rounded-lg shadow-sm">
                <h1 class="text-3xl sm:text-4xl font-bold text-teal-600">Desafio da Sa√∫de 3.0</h1>
                <p class="text-gray-600 font-medium mt-1">üç¥ Edi√ß√£o 2026 (12/01 a 20/12) üí™üèº</p>
                <div id="day-counter-badge" class="inline-block bg-teal-100 text-teal-800 text-sm font-bold px-3 py-1 rounded-full mt-2">
                    Carregando dia...
                </div>
            </header>
            <div class="bg-white p-6 rounded-xl shadow-md max-w-md mx-auto space-y-4">
                <div>
                    <label for="setup-date" class="block text-sm font-medium text-gray-700 mb-1">Data do Check-in:</label>
                    <input type="date" id="setup-date" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="setup-participant" class="block text-sm font-medium text-gray-700 mb-1">Participante:</label>
                    <select id="setup-participant" class="custom-select w-full p-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:ring-teal-500 focus:border-teal-500">
                        <option value="">-- Selecione --</option>
                    </select>
                </div>
                <div id="confirmation-details" class="hidden text-center bg-gray-100 p-3 rounded-lg">
                    <p>Registrando para <strong id="confirm-name"></strong> no dia <strong id="confirm-date"></strong>.</p>
                </div>
                <button id="confirm-setup-btn" disabled class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors duration-200">Confirmar e Continuar</button>
                
                <button id="help-btn" class="w-full bg-indigo-100 text-indigo-700 font-bold py-2 px-4 rounded-lg hover:bg-indigo-200 transition-colors duration-200 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                    Ajuda / Manual
                </button>
            </div>
            
            <div class="max-w-md mx-auto text-center mt-6 space-y-2">
                 <button id="score-table-btn" class="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200">Tabela de Pontua√ß√£o</button>
                 <div class="flex gap-2">
                    <button id="ranking-btn" class="flex-1 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-200">Ranking Geral</button>
                    <button id="monthly-ranking-btn" class="flex-1 bg-amber-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-amber-600 transition-colors duration-200">Ranking Mensal</button>
                </div>
                 <button id="monthly-champions-btn" class="w-full bg-yellow-400 text-black font-bold py-3 px-4 rounded-lg hover:bg-yellow-500 transition-colors duration-200">Campe√µes Mensais</button>
                <div class="flex gap-2">
                    <button id="month-report-btn" class="flex-1 bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition-colors duration-200">Dados do M√™s</button>
                    <button id="full-report-btn" class="flex-1 bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200">Relat√≥rio Geral</button>
                </div>
            </div>
        </div>

        <div id="main-app" class="hidden">
            <header class="text-center mb-4">
                 <h1 class="text-3xl sm:text-4xl font-bold text-teal-600">Check-in Di√°rio</h1>
                 <p class="text-gray-500 mt-1">Participante: <strong id="current-participant-name"></strong> | Data: <strong id="current-checkin-date"></strong></p>
            </header>
             <div id="message-box" class="hidden text-center p-3 mb-6 rounded-lg"></div>

            <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <form id="checkin-form" class="space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2">1. Atividade F√≠sica</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="aerobic-minutes" class="block text-sm font-medium">1.1 Minutos de atividade aer√≥bica hoje:</label>
                                <input type="number" id="aerobic-minutes" min="0" placeholder="Ex: 30" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label for="strength-sessions" class="block text-sm font-medium">1.2 Sess√µes de for√ßa hoje:</label>
                                <input type="number" id="strength-sessions" min="0" max="2" placeholder="Ex: 1" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2">2. Nutri√ß√£o</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="fruit-portions-input" class="block text-sm font-medium text-teal-800">2.1 Quantas por√ß√µes de frutas/vegetais?</label>
                                <div class="flex items-center mt-2 gap-3">
                                    <input type="number" id="fruit-portions-input" min="0" max="10" class="w-20 p-2 text-center border border-gray-300 rounded-lg font-bold text-lg" placeholder="0">
                                    <div class="text-xs text-gray-500">
                                        <p>5+ por√ß√µes = 20 pts</p>
                                        <p>4=12 | 3=6 | 2=4 | 1=2</p>
                                    </div>
                                </div>
                            </div>
                            <hr class="border-gray-200">
                            <div>
                                <label class="block text-sm font-medium mb-2">2.2 Hidrata√ß√£o:</label>
                                <div class="flex items-center"><input id="hydration" type="checkbox" class="h-5 w-5 rounded border-gray-300 text-teal-600"><label for="hydration" class="ml-2">Bebi 2 Litros ou mais de √°gua (15 pts)</label></div>
                            </div>
                            <hr class="border-gray-200">
                            <div>
                                <label class="block text-sm font-medium mb-2 text-teal-800">2.3 Alimenta√ß√£o Limpa (4 pts cada):</label>
                                <div class="grid grid-cols-1 gap-2 text-sm bg-teal-50 p-3 rounded-lg border border-teal-100">
                                    <div class="flex items-center"><input id="clean-no-sweets" type="checkbox" class="h-4 w-4 rounded text-teal-600"><label for="clean-no-sweets" class="ml-2">Zero Doces</label></div>
                                    <div class="flex items-center"><input id="clean-no-soda" type="checkbox" class="h-4 w-4 rounded text-teal-600"><label for="clean-no-soda" class="ml-2">Zero Bebidas A√ßucaradas/Alc.</label></div>
                                    <div class="flex items-center"><input id="clean-no-fastfood" type="checkbox" class="h-4 w-4 rounded text-teal-600"><label for="clean-no-fastfood" class="ml-2">Zero Fast Food</label></div>
                                    <div class="flex items-center"><input id="clean-no-fried" type="checkbox" class="h-4 w-4 rounded text-teal-600"><label for="clean-no-fried" class="ml-2">Zero Gordurosas/Frituras</label></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2">3. Bem-Estar</h2>
                        <div class="space-y-4">
                             <div class="flex items-center text-sm"><input id="sleep" type="checkbox" class="h-4 w-4 rounded border-gray-300"><label for="sleep" class="ml-2">3.1 Dormi 7h+ de sono (10pts)</label></div>
                            <div>
                                <label class="block text-sm font-medium">3.2 Atividades de Cuidado Pessoal (2 pts cada):</label>
                                <div id="selfcare-checklist" class="mt-2 grid grid-cols-2 gap-2 text-sm"></div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" id="submit-checkin-btn" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition-colors duration-200">Finalizar Check-in</button>
                </form>

                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-4">Ranking Geral 2026</h2>
                    <div class="space-y-3" id="leaderboard"></div>
                </div>
            </main>
        </div>

        <div id="summary-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 p-4 z-50 overflow-y-auto">
            <div id="summary-card-frame" class="p-1 bg-gradient-to-br from-teal-400 via-green-400 to-emerald-500 rounded-2xl shadow-2xl w-full max-w-lg mx-auto my-8">
                <div class="bg-white rounded-xl">
                    <div id="summary-content" class="p-6 subtle-bg">
                        <h2 class="text-2xl font-bold text-center text-teal-600 mb-2">Resumo do Check-in</h2>
                        <p class="text-center text-gray-600 mb-4"><strong id="summary-name"></strong> - <span id="summary-date"></span></p>
                        <div class="space-y-3 text-sm">
                            <div id="summary-details" class="bg-gray-50 p-4 rounded-lg space-y-2"></div>
                            <div class="grid grid-cols-2 gap-2 text-center">
                                <div class="bg-teal-100 p-2 rounded"><div class="font-bold text-lg text-teal-800" id="summary-daily-total"></div><div class="text-xs text-teal-700">Pontos do Dia</div></div>
                                <div class="bg-indigo-100 p-2 rounded"><div class="font-bold text-lg text-indigo-800" id="summary-monthly-total"></div><div class="text-xs text-indigo-700">Total no M√™s</div></div>
                            </div>
                            <div id="summary-progress" class="bg-gray-50 p-4 rounded-lg space-y-2"></div>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-100 rounded-b-xl flex flex-col sm:flex-row gap-2">
                        <button id="export-png-btn" class="flex-1 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">Exportar Imagem</button>
                        <button id="close-summary-btn" class="flex-1 bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="thank-you-screen" class="hidden fixed inset-0 text-center flex flex-col items-center justify-start bg-cover bg-center z-40 p-4 pt-8 pb-8 overflow-y-auto">
             <div id="motivational-card" class="bg-white/95 backdrop-blur-sm rounded-xl shadow-lg p-6 w-full max-w-md mx-auto mb-6">
                 <p id="motivational-quote" class="text-center text-lg italic text-gray-700 mb-4"></p>
                 <h3 class="font-bold text-center text-teal-700 text-xl mb-4 border-t pt-4">Tabela de Pontua√ß√£o</h3>
                 <div class="overflow-hidden rounded-lg border border-gray-200">
                     <table class="w-full text-sm text-left text-gray-600">
                         <thead class="bg-gray-50">
                             <tr><th class="p-3 font-bold text-gray-800">Categoria</th><th class="p-3 font-bold text-gray-800 text-right">Pontos</th></tr>
                         </thead>
                         <tbody class="divide-y divide-gray-100">
                            <tr class="bg-gray-200"><td class="p-2 font-bold text-gray-700 pl-3" colspan="2">Meta Aer√≥bica (Semanal)</td></tr>
                            <tr><td class="p-2 pl-6">150+ min</td><td class="p-2 text-right font-medium">175 pts</td></tr>
                            <tr><td class="p-2 pl-6">100 a 129 min</td><td class="p-2 text-right font-medium">122.5 pts</td></tr>
                            <tr><td class="p-2 pl-6">80 a 99 min</td><td class="p-2 text-right font-medium">105 pts</td></tr>
                            <tr><td class="p-2 pl-6">60 a 79 min</td><td class="p-2 text-right font-medium">87.5 pts</td></tr>
                            <tr><td class="p-2 pl-6">40 a 59 min</td><td class="p-2 text-right font-medium">70 pts</td></tr>
                            <tr><td class="p-2 pl-6">20 a 39 min</td><td class="p-2 text-right font-medium">35 pts</td></tr>
                            <tr><td class="p-2 pl-6">1 a 19 min</td><td class="p-2 text-right font-medium">17.5 pts</td></tr>
                            
                            <tr class="bg-gray-200"><td class="p-2 font-bold text-gray-700 pl-3" colspan="2">Meta de For√ßa (Semanal)</td></tr>
                            <tr><td class="p-2 pl-6">2 sess√µes</td><td class="p-2 text-right font-medium">105 pts</td></tr>
                            <tr><td class="p-2 pl-6">1 sess√£o</td><td class="p-2 text-right font-medium">40 pts</td></tr>

                            <tr class="bg-gray-200"><td class="p-2 font-bold text-gray-700 pl-3" colspan="2">Frutas/Vegetais (Di√°rio)</td></tr>
                            <tr><td class="p-2 pl-6">5+ por√ß√µes</td><td class="p-2 text-right font-medium">20 pts</td></tr>
                            <tr><td class="p-2 pl-6">4 por√ß√µes</td><td class="p-2 text-right font-medium">12 pts</td></tr>
                            <tr><td class="p-2 pl-6">3 por√ß√µes</td><td class="p-2 text-right font-medium">6 pts</td></tr>
                            <tr><td class="p-2 pl-6">2 por√ß√µes</td><td class="p-2 text-right font-medium">4 pts</td></tr>
                            <tr><td class="p-2 pl-6">1 por√ß√£o</td><td class="p-2 text-right font-medium">2 pts</td></tr>

                            <tr class="bg-gray-200"><td class="p-2 font-bold text-gray-700 pl-3" colspan="2">Outros (Di√°rio)</td></tr>
                            <tr><td class="p-2 pl-6">2L+ √Ågua</td><td class="p-2 text-right font-medium">15 pts</td></tr>
                            <tr><td class="p-2 pl-6">Cuidado Alimentar</td><td class="p-2 text-right font-medium">16 pts</td></tr>
                            <tr><td class="p-2 pl-6">7h+ Sono</td><td class="p-2 text-right font-medium">10 pts</td></tr>
                            <tr><td class="p-2 pl-6">Cuidado Pessoal (cada)</td><td class="p-2 text-right font-medium">2 pts</td></tr>
                         </tbody>
                      </table>
                </div>
            </div>
            <div class="bg-black bg-opacity-50 p-8 rounded-xl">
                <button id="add-another-checkin-btn" class="bg-teal-600 text-white font-bold text-xl py-4 px-8 rounded-lg hover:bg-teal-700 transition-colors duration-200 shadow-lg">Adicionar mais um check-in?</button>
            </div>
        </div>

        <div id="help-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 p-4 z-50 overflow-y-auto">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-auto my-8">
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-center text-indigo-600 mb-4">Manual do Desafio</h2>
                    <div class="space-y-4 text-sm text-gray-700">
                        <div class="border-l-4 border-teal-500 pl-3">
                            <h3 class="font-bold text-teal-700">Bot√µes da Tela Inicial</h3>
                            <ul class="list-disc pl-4 mt-1">
                                <li><strong>Dados do M√™s:</strong> Baixa planilha com os lan√ßamentos apenas do m√™s atual.</li>
                                <li><strong>Ranking Mensal:</strong> Pontua√ß√£o acumulada no m√™s vigente.</li>
                                <li><strong>Campe√µes Mensais:</strong> Hist√≥rico de quem venceu cada m√™s.</li>
                            </ul>
                        </div>
                        <div class="border-l-4 border-orange-500 pl-3">
                            <h3 class="font-bold text-orange-700">Regras B√°sicas</h3>
                            <p class="mt-1">As metas semanais (Aer√≥bico e For√ßa) somam pontos ao atingir o alvo na semana (seg-dom). As di√°rias somam a cada dia.</p>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-gray-100 rounded-b-xl text-center"><button id="close-help-btn" class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600">Entendi</button></div>
            </div>
        </div>

        <div id="ranking-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 p-4 z-50 overflow-y-auto">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-auto my-8">
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-center text-teal-600 mb-4">Ranking Geral Detalhado</h2>
                    <div id="ranking-modal-list" class="space-y-3"></div>
                </div>
                <div class="p-4 bg-gray-100 rounded-b-xl text-center"><button id="close-ranking-btn" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600">Fechar</button></div>
            </div>
        </div>
        
        <div id="score-table-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 p-4 z-50 overflow-y-auto">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-auto my-8">
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-center text-teal-600 mb-4">Tabela de Pontua√ß√£o</h2>
                    <div id="score-table-content"></div>
                </div>
                <div class="p-4 bg-gray-100 rounded-b-xl text-center"><button id="close-score-table-btn" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600">Fechar</button></div>
            </div>
        </div>

        <div id="monthly-ranking-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 p-4 z-50 overflow-y-auto">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-auto my-8">
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-center text-teal-600 mb-4">Ranking Mensal</h2>
                    <div id="monthly-ranking-list" class="space-y-4"></div>
                </div>
                <div class="p-4 bg-gray-100 rounded-b-xl text-center"><button id="close-monthly-ranking-btn" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600">Fechar</button></div>
            </div>
        </div>
        
        <div id="monthly-champions-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 p-4 z-50 overflow-y-auto">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-auto my-8">
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-center text-teal-600 mb-4">Campe√µes Mensais</h2>
                    <div class="bg-gray-50 p-3 rounded-lg border mb-4">
                        <h4 class="font-bold text-md text-center text-teal-700 mb-2">Placar de Vit√≥rias</h4>
                        <div id="monthly-champions-summary" class="text-sm space-y-1"></div>
                    </div>
                    <div id="monthly-champions-list" class="space-y-2"></div>
                </div>
                <div class="p-4 bg-gray-100 rounded-b-xl text-center"><button id="close-monthly-champions-btn" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600">Fechar</button></div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const participants = ['Carol', 'Iag√™', 'Juliana', 'Mariana', 'Radmila', 'Pedro', 'Lia'];
        const challengeStartDate = new Date('2026-01-12T00:00:00');
        const challengeEndDate = new Date('2026-12-20T23:59:59');
        const SELFCARE_ACTIVITIES = ['Medita√ß√£o ou Mindfulness', 'Alongamento ou Mobilidade', 'Contato com a Natureza', 'Leitura por Prazer', 'Autocuidado Essencial'];
        const MOTIVATIONAL_QUOTES = ["O sucesso √© a soma de pequenos esfor√ßos.", "N√£o espere por inspira√ß√£o, seja a inspira√ß√£o!", "Seu corpo √© seu templo. Cuide bem dele!", "Disciplina √© a ponte entre metas e realiza√ß√µes.", "Cada dia conta. Fa√ßa valer a pena!"];

        let state = { selectedParticipant: null, selectedDate: null, allData: {}, db: null, appId: 'desafio-saude-v3' };

        // Elements
        const loadingScreen=document.getElementById('loading-screen'), setupScreen=document.getElementById('setup-screen'), mainApp=document.getElementById('main-app');
        const thankYouScreen=document.getElementById('thank-you-screen'), rankingModal=document.getElementById('ranking-modal'), scoreTableModal=document.getElementById('score-table-modal');
        const monthlyRankingModal=document.getElementById('monthly-ranking-modal'), monthlyChampionsModal=document.getElementById('monthly-champions-modal'), helpModal=document.getElementById('help-modal');
        const setupDate=document.getElementById('setup-date'), setupParticipant=document.getElementById('setup-participant'), confirmDetails=document.getElementById('confirmation-details');
        const confirmName=document.getElementById('confirm-name'), confirmDate=document.getElementById('confirm-date'), confirmBtn=document.getElementById('confirm-setup-btn');
        const checkinForm=document.getElementById('checkin-form'), leaderboardContainer=document.getElementById('leaderboard'), summaryModal=document.getElementById('summary-modal');
        const messageBox=document.getElementById('message-box'), dayCounterBadge=document.getElementById('day-counter-badge');

        // Helpers
        const getAerobicScore = m => m>=150?175:m>=100?122.5:m>=80?105:m>=60?87.5:m>=40?70:m>=20?35:m>0?17.5:0;
        const getStrengthScore = s => s>=2?105:s>=1?40:0;
        const getFruitScore = p => p>=5?20:p===4?12:p===3?6:p===2?4:p===1?2:0;
        const getSelfCareScore = a => a.length*2;
        const getFormattedDateKey = d => d.toISOString().split('T')[0];
        const getChallengeWeekKey = d => {
            if (d < challengeStartDate) return null;
            const diffDays = Math.floor((d - challengeStartDate) / (1000 * 60 * 60 * 24));
            return `challenge-week-${Math.floor(diffDays / 7)}`;
        };
        const getMonthKey = d => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        const getMonthName = k => { const [y,m] = k.split('-'); return new Date(y,m-1).toLocaleString('pt-BR',{month:'long',year:'numeric'}); };

        const updateDayCounter = () => {
            const today = new Date();
            if (today < challengeStartDate) { dayCounterBadge.textContent = "Come√ßa em 12/01!"; return; }
            if (today > challengeEndDate) { dayCounterBadge.textContent = "Encerrado"; return; }
            const diff = Math.floor((today - challengeStartDate) / (1000 * 60 * 60 * 24)) + 1;
            dayCounterBadge.textContent = `Dia ${diff}`;
        };

        const showMessage = (msg, type='success') => {
            messageBox.textContent = msg;
            messageBox.className = `text-center p-3 mb-6 rounded-lg ${type==='success'?'bg-green-100 text-green-800':type==='info'?'bg-blue-100 text-blue-800':'bg-red-100 text-red-800'}`;
            setTimeout(() => messageBox.className = 'hidden', 4000);
        };

        const populateChecklists = () => {
            document.getElementById('selfcare-checklist').innerHTML = SELFCARE_ACTIVITIES.map(a => `<div class="flex items-center"><input type="checkbox" id="selfcare-${a.replace(/\s/g, '')}" name="selfcare-activity" value="${a}" class="h-4 w-4 rounded border-gray-300"><label for="selfcare-${a.replace(/\s/g, '')}" class="ml-2">${a}</label></div>`).join('');
        };

        const prefillForm = (inputs) => {
            document.getElementById('aerobic-minutes').value = inputs.aerobicMinutes;
            document.getElementById('strength-sessions').value = inputs.strengthSessions;
            document.getElementById('hydration').checked = inputs.hydration;
            document.getElementById('sleep').checked = inputs.sleep;
            document.getElementById('fruit-portions-input').value = inputs.fruitPortions;
            if(inputs.cleanEating) {
                document.getElementById('clean-no-sweets').checked = inputs.cleanEating.noSweets;
                document.getElementById('clean-no-soda').checked = inputs.cleanEating.noSoda;
                document.getElementById('clean-no-fastfood').checked = inputs.cleanEating.noFastFood;
                document.getElementById('clean-no-fried').checked = inputs.cleanEating.noFried;
            }
            document.querySelectorAll('input[name="selfcare-activity"]').forEach(cb => cb.checked = false);
            inputs.selfCareActivities.forEach(a => {
                const cb = document.getElementById(`selfcare-${a.replace(/\s/g, '')}`);
                if(cb) cb.checked = true;
            });
        };

        // Score Calculation
        const calculateAllScores = (name) => {
            const data = state.allData[name] || { dailyLogs: {} };
            const scores = { total: 0, weekly: 0, monthly: 0 };
            const today = new Date();
            const currWeek = getChallengeWeekKey(today);
            const currMonth = getMonthKey(today);
            const wAgg = {};

            for (const dKey in data.dailyLogs) {
                const date = new Date(dKey + 'T12:00:00');
                const week = getChallengeWeekKey(date);
                if (!week) continue;
                if (!wAgg[week]) wAgg[week] = { ae:0, st:0, daily:0, m: getMonthKey(date) };
                
                const inp = data.dailyLogs[dKey].inputs;
                wAgg[week].ae += inp.aerobicMinutes;
                wAgg[week].st += inp.strengthSessions;
                
                let ceScore = 0;
                if(inp.cleanEating) {
                    if(inp.cleanEating.noSweets) ceScore+=4;
                    if(inp.cleanEating.noSoda) ceScore+=4;
                    if(inp.cleanEating.noFastFood) ceScore+=4;
                    if(inp.cleanEating.noFried) ceScore+=4;
                }
                
                wAgg[week].daily += getFruitScore(inp.fruitPortions) + (inp.hydration?15:0) + ceScore + (inp.sleep?10:0) + getSelfCareScore(inp.selfCareActivities);
            }

            for (const w in wAgg) {
                const wkScore = getAerobicScore(wAgg[w].ae) + getStrengthScore(wAgg[w].st) + wAgg[w].daily;
                scores.total += wkScore;
                if (w === currWeek) scores.weekly = wkScore;
                if (wAgg[w].m === currMonth) scores.monthly += wkScore;
            }
            return { name, ...scores };
        };

        const calculateMonthlyScores = (includeCurr) => {
            const monthlyData = {};
            participants.forEach(name => {
                const data = state.allData[name] || { dailyLogs: {} };
                const wAgg = {};
                for (const dKey in data.dailyLogs) {
                    const date = new Date(dKey+'T12:00:00');
                    const w = getChallengeWeekKey(date);
                    if(!w) continue;
                    if(!wAgg[w]) wAgg[w] = { ae:0, st:0, daily:0, m: getMonthKey(date) };
                    const inp = data.dailyLogs[dKey].inputs;
                    wAgg[w].ae += inp.aerobicMinutes;
                    wAgg[w].st += inp.strengthSessions;
                    let ceScore=0;
                    if(inp.cleanEating){
                        if(inp.cleanEating.noSweets) ceScore+=4;
                        if(inp.cleanEating.noSoda) ceScore+=4;
                        if(inp.cleanEating.noFastFood) ceScore+=4;
                        if(inp.cleanEating.noFried) ceScore+=4;
                    }
                    wAgg[w].daily += getFruitScore(inp.fruitPortions) + (inp.hydration?15:0) + ceScore + (inp.sleep?10:0) + getSelfCareScore(inp.selfCareActivities);
                }
                for(const w in wAgg){
                    const total = getAerobicScore(wAgg[w].ae) + getStrengthScore(wAgg[w].st) + wAgg[w].daily;
                    const m = wAgg[w].m;
                    if(!monthlyData[m]) monthlyData[m] = {};
                    if(!monthlyData[m][name]) monthlyData[m][name] = 0;
                    monthlyData[m][name] += total;
                }
            });

            const res = [];
            const currM = getMonthKey(new Date());
            for(const m in monthlyData){
                if(!includeCurr && m===currM) continue;
                const scores = participants.map(p => ({name:p, score:monthlyData[m][p]||0})).sort((a,b)=>b.score-a.score);
                res.push({monthKey:m, monthName:getMonthName(m), scores, isCurrent:m===currM});
            }
            return res.sort((a,b)=>b.monthKey.localeCompare(a.monthKey));
        };

        // UI Updates
        const updateLeaderboardUI = () => {
            const scores = participants.map(calculateAllScores).sort((a,b)=>b.total-a.total);
            leaderboardContainer.innerHTML = scores.map((s,i) => {
                const medal = ['ü•á','ü•à','ü•â'][i]||'üîπ';
                return `<div class="flex justify-between bg-gray-50 p-3 rounded-lg border"><div class="flex items-center"><span class="text-xl w-8">${medal}</span><span class="font-bold">${s.name}</span></div><div class="text-right text-teal-600 font-bold text-lg">${Math.round(s.total)} <span class="text-xs font-normal text-gray-500">Total</span></div></div>`;
            }).join('');
        };

        const updateRankingModalUI = () => {
            const scores = participants.map(calculateAllScores).sort((a,b)=>b.total-a.total);
            document.getElementById('ranking-modal-list').innerHTML = scores.map((s,i) => {
                const medal = ['ü•á','ü•à','ü•â'][i]||'üîπ';
                return `<div class="flex justify-between bg-gray-50 p-3 rounded-lg border"><div><span class="text-xl mr-2">${medal}</span><span class="font-bold">${s.name}</span></div><div class="text-right text-xs"><div>Geral: <b>${Math.round(s.total)}</b></div><div>M√™s: <b>${Math.round(s.monthly)}</b></div></div></div>`;
            }).join('');
        };

        const updateMonthlyRankingUI = () => {
            const data = calculateMonthlyScores(true);
            const el = document.getElementById('monthly-ranking-list');
            if(!data.length) { el.innerHTML='<p class="text-center text-gray-500">Sem dados.</p>'; return; }
            el.innerHTML = data.map(d => {
                const list = d.scores.map((s,i) => `<div class="flex justify-between text-sm py-1"><span>${i+1}. ${s.name}</span><span class="font-semibold">${Math.round(s.score)}</span></div>`).join('');
                return `<div class="bg-gray-50 p-3 rounded-lg border mb-2"><h4 class="font-bold text-teal-700 capitalize">${d.monthName} ${d.isCurrent?'(Atual)':''}</h4><div class="mt-1">${list}</div></div>`;
            }).join('');
        };

        const updateMonthlyChampionsUI = () => {
            const data = calculateMonthlyScores(false);
            const elList = document.getElementById('monthly-champions-list');
            const elSum = document.getElementById('monthly-champions-summary');
            const wins = {};
            const winnersList = [];
            data.forEach(d => {
                if(d.scores.length && d.scores[0].score > 0){
                    const top = d.scores[0].score;
                    const w = d.scores.filter(s=>s.score===top).map(s=>s.name);
                    w.forEach(p => wins[p] = (wins[p]||0)+1);
                    winnersList.push({m:d.monthName, w:w.join(', ')});
                }
            });
            const sortedWins = Object.entries(wins).sort((a,b)=>b[1]-a[1]);
            elSum.innerHTML = sortedWins.length ? sortedWins.map(([n,c]) => `<div class="flex justify-between"><span>${n}</span><span>${c} vit√≥rias</span></div>`).join('') : '<p class="text-center text-gray-500">Sem vit√≥rias ainda.</p>';
            elList.innerHTML = winnersList.length ? winnersList.map(x => `<div class="flex justify-between bg-gray-50 p-2 rounded border mb-1"><span class="capitalize font-bold">${x.m}</span><span>${x.w}</span></div>`).join('') : '<p class="text-center text-gray-500">Nenhum m√™s finalizado.</p>';
        };

        // EXPORT FUNCTIONS
        const exportMonthReport = () => {
            const today = new Date();
            const currentMonthKey = getMonthKey(today);
            const currentMonthName = getMonthName(currentMonthKey);
            const dataSheet = [
                ["Relat√≥rio Mensal - " + currentMonthName], 
                ["Gerado em: " + today.toLocaleDateString('pt-BR')],
                [], 
                ["Nome", "Data", "Aer√≥bico", "For√ßa", "Frutas", "Hidrata√ß√£o", "Alim. Limpa (Itens)", "Sono", "Cuidado"]
            ];
            
            participants.forEach(p => {
                const pData = state.allData[p] || { dailyLogs: {} };
                // Ordenar datas
                const dates = Object.keys(pData.dailyLogs).sort();
                dates.forEach(dKey => {
                    const date = new Date(dKey+'T12:00:00');
                    // FILTRO: Apenas se for do m√™s atual
                    if(getMonthKey(date) === currentMonthKey){
                        const i = pData.dailyLogs[dKey].inputs;
                        const ce = i.cleanEating || {};
                        const ceCount = (ce.noSweets?1:0)+(ce.noSoda?1:0)+(ce.noFastFood?1:0)+(ce.noFried?1:0);
                        dataSheet.push([
                            p, 
                            date.toLocaleDateString('pt-BR'), 
                            i.aerobicMinutes, 
                            i.strengthSessions, 
                            i.fruitPortions, 
                            i.hydration?'Sim':'N√£o', 
                            ceCount+'/4', 
                            i.sleep?'Sim':'N√£o', 
                            i.selfCareActivities.join(', ')
                        ]);
                    }
                });
            });
            const ws = XLSX.utils.aoa_to_sheet(dataSheet); 
            const wb = XLSX.utils.book_new(); 
            XLSX.utils.book_append_sheet(wb, ws, "Dados do M√™s"); 
            XLSX.writeFile(wb, `dados_mes_${currentMonthKey}.xls`);
        };

        const exportFullReport = () => {
            const dataSheet = [["Relat√≥rio Geral"], [], ["Nome", "Data", "Aer√≥bico", "For√ßa", "Frutas", "Hidrata√ß√£o", "Alimenta√ß√£o Limpa", "Sono", "Cuidado"]];
            participants.forEach(p => {
                const pData = state.allData[p] || { dailyLogs: {} };
                Object.keys(pData.dailyLogs).sort().forEach(dKey => {
                    const i = pData.dailyLogs[dKey].inputs;
                    const ce = i.cleanEating || {};
                    const ceCount = (ce.noSweets?1:0)+(ce.noSoda?1:0)+(ce.noFastFood?1:0)+(ce.noFried?1:0);
                    dataSheet.push([p, new Date(dKey+'T12:00:00').toLocaleDateString('pt-BR'), i.aerobicMinutes, i.strengthSessions, i.fruitPortions, i.hydration?'Sim':'N√£o', ceCount+'/4', i.sleep?'Sim':'N√£o', i.selfCareActivities.join(', ')]);
                });
            });
            const ws = XLSX.utils.aoa_to_sheet(dataSheet); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Geral"); XLSX.writeFile(wb, `relatorio_geral.xls`);
        };

        // UI Helpers
        const toggle = (id, show) => document.getElementById(id).classList[show?'remove':'add']('hidden');
        document.getElementById('export-png-btn').onclick = () => { html2canvas(document.getElementById('summary-content'), {scale:2}).then(c => { const l=document.createElement('a'); l.download='resumo.png'; l.href=c.toDataURL(); l.click(); }); };
        
        // Navigation Logic
        document.getElementById('close-summary-btn').onclick = () => { toggle('summary-modal',0); toggle('main-app',0); document.getElementById('motivational-quote').textContent=`"${MOTIVATIONAL_QUOTES[Math.floor(Math.random()*MOTIVATIONAL_QUOTES.length)]}"`; toggle('thank-you-screen',1); };
        document.getElementById('add-another-checkin-btn').onclick = () => { toggle('thank-you-screen',0); toggle('setup-screen',1); setupDate.value=''; setupParticipant.value=''; toggle('confirmation-details',0); confirmBtn.disabled=true; };
        
        document.getElementById('ranking-btn').onclick = () => { updateRankingModalUI(); toggle('ranking-modal',1); };
        document.getElementById('monthly-ranking-btn').onclick = () => { updateMonthlyRankingUI(); toggle('monthly-ranking-modal',1); };
        document.getElementById('monthly-champions-btn').onclick = () => { updateMonthlyChampionsUI(); toggle('monthly-champions-modal',1); };
        document.getElementById('score-table-btn').onclick = () => { document.querySelector('#score-table-content').innerHTML = document.querySelector('#motivational-card table').outerHTML; toggle('score-table-modal',1); };
        document.getElementById('help-btn').onclick = () => toggle('help-modal',1);
        
        document.getElementById('month-report-btn').onclick = exportMonthReport;
        document.getElementById('full-report-btn').onclick = exportFullReport;

        ['ranking','score-table','monthly-ranking','monthly-champions','help'].forEach(n => document.getElementById(`close-${n}-btn`).onclick = () => toggle(`${n}-modal`,0));

        const validateSetup = () => {
            const d = setupDate.value, p = setupParticipant.value;
            if(d && p) {
                const date = new Date(d+'T12:00:00');
                if(date < challengeStartDate) { confirmBtn.disabled=true; showMessage('Data anterior ao in√≠cio do desafio.', 'error'); return; }
                state.selectedDate = date; state.selectedParticipant = p;
                confirmName.textContent = p; confirmDate.textContent = date.toLocaleDateString('pt-BR');
                toggle('confirmation-details',1); confirmBtn.disabled=false;
            } else { confirmBtn.disabled=true; toggle('confirmation-details',0); }
        };
        setupDate.onchange = validateSetup; setupParticipant.onchange = validateSetup;

        confirmBtn.onclick = () => {
            toggle('setup-screen',0); toggle('main-app',1);
            document.getElementById('current-participant-name').textContent = state.selectedParticipant;
            document.getElementById('current-checkin-date').textContent = state.selectedDate.toLocaleDateString('pt-BR');
            checkinForm.reset(); toggle('message-box',0);
            const logs = state.allData[state.selectedParticipant]?.dailyLogs || {};
            const key = getFormattedDateKey(state.selectedDate);
            if(logs[key]) { showMessage('Editando registro existente.', 'info'); prefillForm(logs[key].inputs); }
            updateLeaderboardUI();
        };

        checkinForm.onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-checkin-btn');
            btn.disabled=true; btn.textContent="Salvando...";
            
            try {
                const inputs = {
                    aerobicMinutes: +document.getElementById('aerobic-minutes').value||0,
                    strengthSessions: +document.getElementById('strength-sessions').value||0,
                    fruitPortions: +document.getElementById('fruit-portions-input').value||0,
                    hydration: document.getElementById('hydration').checked,
                    cleanEating: {
                        noSweets: document.getElementById('clean-no-sweets').checked,
                        noSoda: document.getElementById('clean-no-soda').checked,
                        noFastFood: document.getElementById('clean-no-fastfood').checked,
                        noFried: document.getElementById('clean-no-fried').checked
                    },
                    sleep: document.getElementById('sleep').checked,
                    selfCareActivities: Array.from(document.querySelectorAll('input[name="selfcare-activity"]:checked')).map(el=>el.value)
                };

                const key = getFormattedDateKey(state.selectedDate);
                const currentData = state.allData[state.selectedParticipant] || { dailyLogs: {} };
                currentData.dailyLogs[key] = { inputs };
                
                // MUDAN√áA: Salvamento mais robusto
                const docRef = doc(state.db, `artifacts/${state.appId}/public/data/healthChallenge`, state.selectedParticipant);
                await setDoc(docRef, currentData, { merge: true });
                
                // Atualiza estado local imediatamente
                state.allData[state.selectedParticipant] = currentData;
                
                showMessage('Salvo com sucesso!');
                setTimeout(() => { if(document.getElementById('summary-daily-total')) showSummary(); }, 200);

            } catch (err) {
                console.error(err);
                showMessage('Erro ao salvar. Verifique sua conex√£o.', 'error');
            } finally {
                btn.disabled=false; btn.textContent="Finalizar Check-in";
            }
        };

        const init = async () => {
            try {
                const app = initializeApp({
                    apiKey: "AIzaSyCzVuw8VwY2e0qr1DngYQdp4En5je4HmyI",
                    authDomain: "desafio-explorar-vizinhanca.firebaseapp.com",
                    projectId: "desafio-explorar-vizinhanca",
                    storageBucket: "desafio-explorar-vizinhanca.firebasestorage.app",
                    messagingSenderId: "535102451702",
                    appId: "1:535102451702:web:b626d741c44952c78da1d7"
                });
                state.db = getFirestore(app);
                await signInAnonymously(getAuth(app));

                const colRef = collection(state.db, `artifacts/${state.appId}/public/data/healthChallenge`);
                onSnapshot(colRef, (snap) => {
                    snap.docs.forEach(d => state.allData[d.id] = d.data());
                    if(!document.getElementById('main-app').classList.contains('hidden')) updateLeaderboardUI();
                });

                setupParticipant.innerHTML = '<option value="">-- Selecione --</option>' + participants.map(p => `<option value="${p}">${p}</option>`).join('');
                populateChecklists();
                document.querySelector('#score-table-content').innerHTML = document.querySelector('#motivational-card table').outerHTML;
                updateDayCounter();
                toggle('loading-screen',0); toggle('setup-screen',1);
            } catch (e) {
                console.error(e);
                loadingScreen.innerHTML = `<p class="text-red-500 font-bold">Erro de conex√£o.</p>`;
            }
        };
        init();
    </script>
</body>
</html>