<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desafio da Sa√∫de 3.0 - Edi√ß√£o 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none !important; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .custom-select {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236B7280%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22/%3E%3C/svg%3E');
            background-repeat: no-repeat; background-position: right 0.7rem center; background-size: 0.65rem auto;
        }
        .subtle-bg {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='49' viewBox='0 0 28 49'%3E%3Cg fill-rule='evenodd'%3E%3Cg id='hexagons' fill='%23e2f3f1' fill-opacity='0.4' fill-rule='nonzero'%3E%3Cpath d='M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9v12.7l10.99 6.34 11-6.35V17.9l-11-6.34L3 17.9zM0 15l12.99-7.5L26 15v18.5L13 41 0 33.5V15z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        #thank-you-screen {
            background-image: url('imagens/tela_final.png'); 
            background-size: cover;
            background-position: center;
        }
        .selector-btn {
            border: 2px solid #e5e7eb;
            color: #4b5563;
            background-color: white;
            transition: all 0.2s;
        }
        .selector-btn:hover {
            border-color: #0d9488;
            color: #0d9488;
        }
        .selector-btn.active {
            background-color: #0d9488;
            border-color: #0d9488;
            color: white;
            font-weight: bold;
            transform: scale(1.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .table-container {
            overflow-x: auto;
            margin-bottom: 1.5rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 300px;
        }
        th, td {
            border: 1px solid #e2e8f0;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f8fafc;
            font-weight: bold;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app-container" class="container mx-auto p-4 sm:p-6 max-w-5xl">
        
        <div id="loading-screen" class="text-center p-10">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-gray-600">Conectando ao servidor...</p>
        </div>

        <div id="setup-screen" class="hidden">
            <header class="text-center mb-6 max-w-md mx-auto">
                 <img src="imagens/logo_desafio.png" alt="logo" class="mx-auto w-full max-w-xs rounded-lg mb-4" onerror="this.style.display='none'">
                <h1 class="text-3xl sm:text-4xl font-bold text-teal-600">Desafio da Sa√∫de 3.0</h1>
                <p class="text-gray-500 mt-1 font-semibold">üç¥Edi√ß√£o 2026 (12/01 a 20/12)üí™üèº</p>
                <div id="day-counter" class="mt-2 text-2xl font-bold text-orange-600 bg-orange-100 py-2 px-4 rounded-full inline-block"></div>
            </header>

            <div class="bg-white p-6 rounded-xl shadow-md max-w-md mx-auto space-y-4 relative">
                <div>
                    <label for="setup-date" class="block text-sm font-medium text-gray-700 mb-1">Data do Check-in:</label>
                    <input type="date" id="setup-date" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="setup-participant" class="block text-sm font-medium text-gray-700 mb-1">Participante:</label>
                    <select id="setup-participant" class="custom-select w-full p-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:ring-teal-500 focus:border-teal-500">
                        <option value="">-- Selecione --</option>
                    </select>
                </div>
                <div id="confirmation-details" class="hidden text-center bg-gray-100 p-3 rounded-lg">
                    <p>Registrando para <strong id="confirm-name"></strong> no dia <strong id="confirm-date"></strong>.</p>
                </div>
                <button id="confirm-setup-btn" disabled class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors duration-200">Confirmar e Continuar</button>
            </div>
            
            <div class="max-w-md mx-auto text-center mt-6 space-y-2">
                <button id="score-table-btn" class="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-200">Tabela de Pontua√ß√£o</button>
                <div class="flex gap-2">
                    <button id="chart-btn" class="flex-1 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-200">Ranking dos Meses</button>
                    <button id="monthly-ranking-btn" class="flex-1 bg-amber-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-amber-600 transition-colors duration-200">Ranking Mensal</button>
                </div>
                <button id="monthly-report-btn" class="w-full bg-green-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-200">üìÇ Baixar Dados do M√™s (Excel)</button>
                
                <div class="flex gap-2">
                    <button id="full-report-btn" class="w-full bg-sky-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200">üìÇ Baixar Dados do Desafio (Excel)</button>
                </div>
            </div>

            <div id="regras-ajuda-container" class="max-w-2xl mx-auto mt-12 p-6 bg-white rounded-xl shadow-md border border-gray-200">
                <div class="border-b pb-4 mb-4 text-center">
                    <h1 class="text-2xl font-bold text-gray-800">REGRAS DO DESAFIO</h1>
                </div>

                <div class="text-gray-700 space-y-6 text-left">
                    <section>
                        <h2 class="text-xl font-semibold text-blue-600">üéØ Objetivo</h2>
                        <p class="mt-2 text-sm">Incentivar h√°bitos b√°sicos e eficazes para melhorar a sa√∫de, como alimenta√ß√£o equilibrada e movimento regular, de acordo com as recomenda√ß√µes da OMS (modificado).</p>
                        <ul class="list-disc ml-5 mt-2 text-sm">
                            <li>Cada a√ß√£o vale pontos, e vence quem acumular mais pontos no m√™s.</li>
                            <li>O vencedor recebe um PIX de R$ 60,00, proveniente da contribui√ß√£o de R$ 10,00 de cada participante n√£o vencedor.</li>
                            <li>Grupo composto por 7 participantes.</li>
                        </ul>
                    </section>

                    <hr>

                    <section>
                        <h2 class="text-xl font-semibold text-green-600 uppercase">Exerc√≠cio F√≠sico</h2>
                        <p class="text-xs italic text-gray-500 mt-1">Diferen√ßa: Atividade f√≠sica √© qualquer movimento cotidiano; Exerc√≠cio f√≠sico √© planejado e repetitivo com objetivo de sa√∫de.</p>
                        
                        <h3 class="font-bold mt-4">Meta Aer√≥bica (150 min/semana)</h3>
                        <p class="text-sm">Ex: Caminhada, corrida, nata√ß√£o, dan√ßa.</p>
                        <div class="table-container mt-2">
                            <table>
                                <thead>
                                    <tr><th>Tempo Semanal</th><th>Pontos</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>150+ min</td><td>175 pts</td></tr>
                                    <tr><td>100 a 149 min</td><td>122.5 pts</td></tr>
                                    <tr><td>80 a 99 min</td><td>105 pts</td></tr>
                                    <tr><td>60 a 79 min</td><td>87.5 pts</td></tr>
                                    <tr><td>40 a 59 min</td><td>70 pts</td></tr>
                                    <tr><td>20 a 39 min</td><td>35 pts</td></tr>
                                    <tr><td>1 a 19 min</td><td>17.5 pts</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <h3 class="font-bold mt-4">Meta de For√ßa (2 sess√µes/semana)</h3>
                        <p class="text-sm">Ex: Muscula√ß√£o, pilates, exerc√≠cios com peso do corpo.</p>
                        <div class="table-container mt-2">
                            <table>
                                <thead>
                                    <tr><th>Sess√µes Semanais</th><th>Pontos</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>1 sess√£o</td><td>40 pts</td></tr>
                                    <tr><td>2 sess√µes</td><td>105 pts</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <hr>

                    <section>
                        <h2 class="text-xl font-semibold text-orange-600 uppercase">Alimenta√ß√£o</h2>
                        <h3 class="font-bold">Meta: 5 por√ß√µes di√°rias de frutas/vegetais</h3>
                        <div class="table-container mt-2">
                            <table>
                                <thead>
                                    <tr><th>Por√ß√µes Di√°rias</th><th>Pontos</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>5+ por√ß√µes</td><td>20 pts</td></tr>
                                    <tr><td>4 por√ß√µes</td><td>12 pts</td></tr>
                                    <tr><td>3 por√ß√µes</td><td>6 pts</td></tr>
                                    <tr><td>2 por√ß√µes</td><td>4 pts</td></tr>
                                    <tr><td>1 por√ß√£o</td><td>2 pts</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <hr>

                    <section>
                        <h2 class="text-xl font-semibold text-teal-600 uppercase">Hidrata√ß√£o e Bem-Estar</h2>
                        <div class="table-container mt-2">
                            <table>
                                <thead>
                                    <tr><th>Categoria</th><th>Meta / Item</th><th>Pontos</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Hidrata√ß√£o</td><td>M√≠nimo 2L de √°gua/dia</td><td>15 pts</td></tr>
                                    <tr><td rowspan="4">Alimenta√ß√£o Limpa</td><td>Sem doces</td><td>4 pts</td></tr>
                                    <tr><td>Sem fast food</td><td>4 pts</td></tr>
                                    <tr><td>Sem bebidas industrializadas</td><td>4 pts</td></tr>
                                    <tr><td>Sem comidas gordurosas</td><td>4 pts</td></tr>
                                    <tr><td>Sono</td><td>M√≠nimo 7h cont√≠nuas</td><td>10 pts</td></tr>
                                    <tr><td rowspan="4">Cuidado Pessoal</td><td>Medita√ß√£o (min 15 min)</td><td>2 pts</td></tr>
                                    <tr><td>Alongamento (min 15 min)</td><td>2 pts</td></tr>
                                    <tr><td>Contato com a natureza</td><td>2 pts</td></tr>
                                    <tr><td>Leitura por prazer</td><td>2 pts</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>
            </div>
            <div class="h-10"></div> </div>

        <div id="main-app" class="hidden">
            <header class="text-center mb-4">
                 <h1 class="text-3xl sm:text-4xl font-bold text-teal-600">Check-in Di√°rio</h1>
                 <p class="text-gray-500 mt-1">Participante: <strong id="current-participant-name"></strong> | Data: <strong id="current-checkin-date"></strong></p>
            </header>
             <div id="message-box" class="hidden text-center p-3 mb-6 rounded-lg"></div>

            <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <form id="checkin-form" class="space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2">1. Atividade F√≠sica</h2>
                        <div class="space-y-6">
                            <div>
                                <label for="aerobic-minutes" class="block text-sm font-medium mb-1">1.1 Minutos de atividade aer√≥bica hoje:</label>
                                <input type="number" id="aerobic-minutes" min="0" max="300" placeholder="0 a 300" class="mt-1 w-full p-3 border border-gray-300 rounded-lg text-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">1.2 Sess√µes de for√ßa hoje:</label>
                                <div class="flex items-center p-3 bg-red-50 rounded-lg border border-red-100">
                                    <input id="strength-check" type="checkbox" class="h-6 w-6 rounded border-gray-300 text-red-600 focus:ring-red-500">
                                    <label for="strength-check" class="ml-3 font-medium text-red-900">Realizei treino de for√ßa</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2">2. Nutri√ß√£o</h2>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-teal-800 mb-2">2.1 Quantas por√ß√µes de frutas/vegetais?</label>
                                <div class="grid grid-cols-6 gap-2" id="fruit-selector">
                                    <button type="button" class="selector-btn fruit-option py-3 rounded-lg font-medium" data-value="0">0</button>
                                    <button type="button" class="selector-btn fruit-option py-3 rounded-lg font-medium" data-value="1">1</button>
                                    <button type="button" class="selector-btn fruit-option py-3 rounded-lg font-medium" data-value="2">2</button>
                                    <button type="button" class="selector-btn fruit-option py-3 rounded-lg font-medium" data-value="3">3</button>
                                    <button type="button" class="selector-btn fruit-option py-3 rounded-lg font-medium" data-value="4">4</button>
                                    <button type="button" class="selector-btn fruit-option py-3 rounded-lg font-medium" data-value="5">5+</button>
                                </div>
                                <input type="hidden" id="fruit-portions-input" value="0">
                                
                                <div class="text-xs text-gray-500 mt-2 flex justify-between px-1">
                                    <span>0 pts</span>
                                    <span>2 pts</span>
                                    <span>4 pts</span>
                                    <span>6 pts</span>
                                    <span>12 pts</span>
                                    <span class="font-bold text-teal-600">20 pts</span>
                                </div>
                            </div>
                            
                            <hr class="border-gray-200">

                            <div>
                                <label class="block text-sm font-medium mb-2">2.2 Hidrata√ß√£o:</label>
                                <div class="flex items-center p-3 bg-blue-50 rounded-lg border border-blue-100">
                                    <input id="hydration" type="checkbox" class="h-6 w-6 rounded border-gray-300 text-teal-600 focus:ring-teal-500">
                                    <label for="hydration" class="ml-3 font-medium text-blue-900">Bebi 2 Litros ou mais de √°gua (15 pts)</label>
                                </div>
                            </div>

                            <hr class="border-gray-200">

                            <div>
                                <label class="block text-sm font-medium mb-2 text-teal-800">2.3 Cuidado alimentar (4 pts cada item):</label>
                                <div class="grid grid-cols-1 gap-2 text-sm bg-teal-50 p-3 rounded-lg border border-teal-100">
                                    <div class="flex items-center p-1">
                                        <input id="clean-no-sweets" type="checkbox" class="h-5 w-5 rounded border-gray-300 text-teal-600 focus:ring-teal-500">
                                        <label for="clean-no-sweets" class="ml-2">Zero Doces (chocolate, balas, bolos...)</label>
                                    </div>
                                    <div class="flex items-center p-1">
                                        <input id="clean-no-soda" type="checkbox" class="h-5 w-5 rounded border-gray-300 text-teal-600 focus:ring-teal-500">
                                        <label for="clean-no-soda" class="ml-2">Zero Bebidas A√ßucaradas e Alc√≥licas</label>
                                    </div>
                                    <div class="flex items-center p-1">
                                        <input id="clean-no-fastfood" type="checkbox" class="h-5 w-5 rounded border-gray-300 text-teal-600 focus:ring-teal-500">
                                        <label for="clean-no-fastfood" class="ml-2">Zero Fast Food (Mc, BK...)</label>
                                    </div>
                                    <div class="flex items-center p-1">
                                        <input id="clean-no-fried" type="checkbox" class="h-5 w-5 rounded border-gray-300 text-teal-600 focus:ring-teal-500">
                                        <label for="clean-no-fried" class="ml-2">Zero Comidas Gordurosas (frituras...)</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2">3. Bem-Estar</h2>
                        <div class="space-y-4">
                             <div class="flex items-center text-sm p-3 bg-purple-50 rounded-lg border border-purple-100">
                                <input id="sleep" type="checkbox" class="h-6 w-6 rounded border-gray-300 text-teal-600 focus:ring-teal-500">
                                <label for="sleep" class="ml-3 font-medium text-purple-900">3.1 Dormi 7h+ de sono (10pts)</label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium">3.2 Atividades de Cuidado Pessoal (2 pts cada):</label>
                                <p class="text-xs text-gray-500 mb-1">*Autocuidado Essencial n√£o soma pontos.</p>
                                <div id="selfcare-checklist" class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm"></div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <button type="submit" id="submit-checkin-btn" class="w-full bg-teal-600 text-white font-bold py-4 px-4 rounded-xl hover:bg-teal-700 transition-colors duration-200 text-lg shadow-lg">
                            Finalizar Check-in
                        </button>
                        <button type="button" id="back-home-checkin-btn" class="w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-xl hover:bg-gray-600 transition-colors duration-200">
                            Voltar para P√°gina Inicial
                        </button>
                    </div>
                </form>

                <div class="bg-white p-6 rounded-xl shadow-md h-fit">
                    <h2 class="text-xl font-bold mb-4">Ranking Mensal (Simples)</h2>
                    <div class="space-y-3" id="leaderboard"></div>
                </div>
            </main>
        </div>

        <div id="summary-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 p-4 z-50 overflow-y-auto flex items-center justify-center">
            <div id="summary-card-frame" class="p-1 bg-gradient-to-br from-teal-400 via-green-400 to-emerald-500 rounded-2xl shadow-2xl w-full max-w-lg">
                <div class="bg-white rounded-xl">
                    <div id="summary-content" class="p-6 subtle-bg">
                        <h2 class="text-2xl font-bold text-center text-teal-600 mb-2">Resumo do Check-in</h2>
                        <p class="text-center text-gray-600 mb-4">
                            <strong id="summary-name"></strong> - <span id="summary-date"></span>
                        </p>
                        <div class="space-y-3 text-sm">
                            <div id="summary-details" class="bg-gray-50 p-4 rounded-lg space-y-2"></div>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-center">
                                <div class="bg-teal-100 p-2 rounded"><div class="font-bold text-lg text-teal-800" id="summary-daily-total"></div><div class="text-xs text-teal-700">Pontos do Dia</div></div>
                                <div class="bg-indigo-100 p-2 rounded"><div class="font-bold text-lg text-indigo-800" id="summary-monthly-total"></div><div class="text-xs text-indigo-700">Total M√™s</div></div>
                            </div>
                            <div id="summary-progress" class="bg-gray-50 p-4 rounded-lg space-y-2"></div>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-100 rounded-b-xl flex flex-col sm:flex-row gap-2">
                        <button id="export-png-btn" class="flex-1 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">Salvar Imagem</button>
                        <button id="close-summary-btn" class="flex-1 bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="thank-you-screen" class="hidden fixed inset-0 text-center flex flex-col items-center justify-start bg-cover bg-center z-40 p-4 pt-8 pb-8 overflow-y-auto">
             <div id="motivational-card" class="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-6 w-full max-w-md mx-auto mb-6">
                 <p id="motivational-quote" class="text-center text-lg italic text-gray-700 mb-4"></p>
                 <h3 class="font-bold text-center text-teal-600 mb-2 border-t pt-4">Tabela de Pontos 3.0</h3>
                 <div id="final-score-table-container"></div>
            </div>
            <div class="bg-black bg-opacity-50 p-8 rounded-xl space-y-4">
                <button id="add-another-checkin-btn" class="w-full bg-teal-600 text-white font-bold text-xl py-4 px-8 rounded-lg hover:bg-teal-700 transition-colors duration-200 shadow-lg">Adicionar mais um check-in?</button>
                <button id="back-home-final-btn" class="w-full bg-gray-600 text-white font-bold text-lg py-3 px-8 rounded-lg hover:bg-gray-700 transition-colors duration-200 shadow-lg">Voltar para In√≠cio</button>
            </div>
        </div>

        <div id="chart-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 p-4 z-50 overflow-y-auto flex items-center justify-center">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[500px] flex flex-col">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-teal-600">Ranking dos Meses (Evolu√ß√£o)</h2>
                    <button id="close-chart-btn" class="text-gray-500 hover:text-red-500 text-2xl">&times;</button>
                </div>
                <div class="flex-1 p-4 relative">
                    <canvas id="evolutionChart"></canvas>
                </div>
            </div>
        </div>
        
        <div id="score-table-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 p-4 z-50 overflow-y-auto flex items-center justify-center">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-center text-teal-600 mb-4">Tabela de Pontua√ß√£o</h2>
                    <div id="score-table-content"></div>
                </div>
                <div class="p-4 bg-gray-100 rounded-b-xl text-center"><button id="close-score-table-btn" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600">Fechar</button></div>
            </div>
        </div>

        <div id="monthly-ranking-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 p-4 z-50 overflow-y-auto flex items-center justify-center">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-center text-teal-600 mb-4">Ranking Mensal</h2>
                    <p class="text-center text-gray-500 mb-4 text-sm">Pontos acumulados no m√™s atual</p>
                    <div id="monthly-ranking-list" class="space-y-4"></div>
                </div>
                <div class="p-4 bg-gray-100 rounded-b-xl text-center"><button id="close-monthly-ranking-btn" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600">Fechar</button></div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- CONFIGURA√á√ÉO 3.0 ---
        const participants = ['Carol', 'Iag√™', 'Juliana', 'Mariana', 'Radmila', 'Pedro', 'Lia'];
        const participantColors = [
            '#377eb8', '#ff7f00', '#4daf4a', '#f781bf', '#a65628', '#984ea3', '#999999'
        ];
        
        const challengeStartDate = new Date('2026-01-12T00:00:00');
        const challengeEndDate = new Date('2026-12-20T23:59:59');

        const SELFCARE_ACTIVITIES = ['Medita√ß√£o ou Mindfulness', 'Alongamento ou Mobilidade', 'Contato com a Natureza', 'Leitura por Prazer', 'Autocuidado Essencial'];
        const MOTIVATIONAL_QUOTES = [
            "Cada passo conta. Continue em frente!",
            "O seu corpo de amanh√£ agradece o seu esfor√ßo de hoje.",
            "Consist√™ncia √© a chave. Vamos l√°!",
            "Foco no progresso, n√£o na perfei√ß√£o.",
            "Cuide do seu corpo, √© o √∫nico lugar que voc√™ tem para viver."
        ];

        let state = {
            selectedParticipant: null,
            selectedDate: null,
            allData: {},
            db: null,
            appId: 'desafio-saude-v3',
            chartInstance: null
        };

        // --- DOM Elements ---
        const loadingScreen = document.getElementById('loading-screen');
        const setupScreen = document.getElementById('setup-screen');
        const mainApp = document.getElementById('main-app');
        const thankYouScreen = document.getElementById('thank-you-screen');
        
        const setupDate = document.getElementById('setup-date');
        const setupParticipant = document.getElementById('setup-participant');
        const confirmDetails = document.getElementById('confirmation-details');
        const confirmName = document.getElementById('confirm-name');
        const confirmDate = document.getElementById('confirm-date');
        const confirmBtn = document.getElementById('confirm-setup-btn');
        const checkinForm = document.getElementById('checkin-form');
        const leaderboardContainer = document.getElementById('leaderboard');
        const summaryModal = document.getElementById('summary-modal');
        const messageBox = document.getElementById('message-box');
        const dayCounterEl = document.getElementById('day-counter');
        
        const fruitOptions = document.querySelectorAll('.fruit-option');

        // Modals Elements
        const chartModal = document.getElementById('chart-modal');
        const scoreTableModal = document.getElementById('score-table-modal');
        const monthlyRankingModal = document.getElementById('monthly-ranking-modal');

        // --- HELPER FUNCTIONS ---
        const getAerobicScore = (minutes) => {
            if (minutes >= 150) return 175;
            if (minutes >= 100) return 122.5;
            if (minutes >= 80) return 105;
            if (minutes >= 60) return 87.5;
            if (minutes >= 40) return 70;
            if (minutes >= 20) return 35;
            if (minutes > 0) return 17.5;
            return 0;
        };
        const getStrengthScore = (sessions) => {
            if (sessions >= 2) return 105;
            if (sessions >= 1) return 40; 
            return 0;
        };
        const getFruitScore = (portions) => {
            if (portions >= 5) return 20;
            if (portions === 4) return 12;
            if (portions === 3) return 6;
            if (portions === 2) return 4;
            if (portions === 1) return 2;
            return 0;
        };
        const getSelfCareScore = (activities) => {
            const validActivities = activities.filter(a => a !== 'Autocuidado Essencial');
            return validActivities.length * 2;
        };

        const getFormattedDateKey = (d) => d.toISOString().split('T')[0];
        
        const getChallengeWeekIndex = (d) => {
             if (d < challengeStartDate) return -1;
             const diffTime = d - challengeStartDate;
             const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
             return Math.floor(diffDays / 7);
        };

        const getMonthKey = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;

        // 7. Contador de Dias
        const updateDayCounter = () => {
            const now = new Date();
            const start = new Date(challengeStartDate);
            const diffTime = now.setHours(0,0,0,0) - start.setHours(0,0,0,0);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 
            
            if (diffDays < 1) {
                dayCounterEl.textContent = `Faltam ${Math.abs(diffDays - 1)} dias`;
            } else {
                dayCounterEl.textContent = `Dia ${diffDays}`;
            }
        };

        const showMessage = (message, type = 'success') => {
            messageBox.textContent = message;
            messageBox.className = `text-center p-3 mb-6 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800' : type === 'error' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        };

        const populateChecklists = () => {
            const selfcareContainer = document.getElementById('selfcare-checklist');
            selfcareContainer.innerHTML = SELFCARE_ACTIVITIES.map(activity => `<div class="flex items-center"><input type="checkbox" id="selfcare-${activity.replace(/\s/g, '')}" name="selfcare-activity" value="${activity}" class="h-5 w-5 rounded border-gray-300 text-teal-600 focus:ring-teal-500"><label for="selfcare-${activity.replace(/\s/g, '')}" class="ml-2">${activity}</label></div>`).join('');
        };

        const showMotivationalCard = () => {
            const quoteElement = document.getElementById('motivational-quote');
            const randomIndex = Math.floor(Math.random() * MOTIVATIONAL_QUOTES.length);
            quoteElement.textContent = `"${MOTIVATIONAL_QUOTES[randomIndex]}"`;
        };
        
        const populateScoreTableModal = () => {
            const scoreTableContainer = document.getElementById('score-table-content');
            const finalScoreTableContainer = document.getElementById('final-score-table-container');
            
            const tableHTML = `
            <table class="w-full text-sm text-left text-gray-600 border">
              <thead class="bg-gray-100"><tr><th class="p-2">Meta</th><th class="p-2 text-right">Pts</th></tr></thead>
              <tbody>
                <tr class="bg-gray-200"><td colspan="2" class="p-1 font-bold">Semanal</td></tr>
                <tr><td>Aer√≥bico 150min+</td><td class="text-right">175</td></tr>
                <tr><td>For√ßa 2x</td><td class="text-right">105</td></tr>
                <tr class="bg-gray-200"><td colspan="2" class="p-1 font-bold">Di√°rio</td></tr>
                <tr><td>5+ Frutas/Veg</td><td class="text-right">20</td></tr>
                <tr><td>2L √Ågua</td><td class="text-right">15</td></tr>
                <tr><td>Sono 7h</td><td class="text-right">10</td></tr>
                <tr><td>Alim. Limpa (4 itens)</td><td class="text-right">16</td></tr>
                <tr><td>Autocuidado (cada)</td><td class="text-right">2</td></tr>
              </tbody>
            </table>`;
            
            scoreTableContainer.innerHTML = tableHTML;
            finalScoreTableContainer.innerHTML = tableHTML;
        };
        
        // --- SELECTOR LOGIC ---
        const setupSelectors = () => {
            const handleSelection = (options, hiddenInputId) => {
                options.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        options.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        document.getElementById(hiddenInputId).value = btn.getAttribute('data-value');
                    });
                });
            };
            handleSelection(fruitOptions, 'fruit-portions-input');
        };
        
        const setSelectorValue = (options, value) => {
             options.forEach(b => b.classList.remove('active'));
             const target = Array.from(options).find(b => b.getAttribute('data-value') == value);
             if (target) {
                 target.classList.add('active');
             } else if (value >= 5 && options === fruitOptions) {
                 options[5].classList.add('active');
             } else {
                 options[0].classList.add('active');
             }
        };

        const prefillForm = (inputs) => {
            document.getElementById('aerobic-minutes').value = inputs.aerobicMinutes;
            
            const strengthCheck = document.getElementById('strength-check');
            strengthCheck.checked = (inputs.strengthSessions > 0);

            document.getElementById('fruit-portions-input').value = inputs.fruitPortions;
            setSelectorValue(fruitOptions, inputs.fruitPortions);
            document.getElementById('hydration').checked = inputs.hydration;
            document.getElementById('sleep').checked = inputs.sleep;

            if (inputs.cleanEating) {
                document.getElementById('clean-no-sweets').checked = inputs.cleanEating.noSweets;
                document.getElementById('clean-no-soda').checked = inputs.cleanEating.noSoda;
                document.getElementById('clean-no-fastfood').checked = inputs.cleanEating.noFastFood;
                document.getElementById('clean-no-fried').checked = inputs.cleanEating.noFried;
            } else {
                ['clean-no-sweets', 'clean-no-soda', 'clean-no-fastfood', 'clean-no-fried'].forEach(id => document.getElementById(id).checked = false);
            }

            document.querySelectorAll('input[name="selfcare-activity"]').forEach(cb => cb.checked = false);
            inputs.selfCareActivities.forEach(activity => {
                const cb = document.getElementById(`selfcare-${activity.replace(/\s/g, '')}`);
                if (cb) cb.checked = true;
            });
        };
        
        const resetFormVisuals = () => {
             checkinForm.reset();
             setSelectorValue(fruitOptions, 0);
             document.getElementById('fruit-portions-input').value = 0;
        }

        // --- CALCULATION LOGIC (Monthly Fix) ---
        const calculateScoresByMonth = (participantName) => {
            const participantData = state.allData[participantName] || { dailyLogs: {} };
            const monthlyScores = {}; 
            const weeklyAggregates = {};

            // 1. Calcular pontos DI√ÅRIOS
            for (const dateKey in participantData.dailyLogs) {
                const logDate = new Date(dateKey + 'T12:00:00');
                const monthKey = getMonthKey(logDate);
                const inputs = participantData.dailyLogs[dateKey].inputs;

                if (!monthlyScores[monthKey]) monthlyScores[monthKey] = 0;

                let dailyPoints = getFruitScore(inputs.fruitPortions) + 
                                  (inputs.hydration ? 15 : 0) + 
                                  (inputs.sleep ? 10 : 0) +
                                  getSelfCareScore(inputs.selfCareActivities);

                if (inputs.cleanEating) {
                    if (inputs.cleanEating.noSweets) dailyPoints += 4;
                    if (inputs.cleanEating.noSoda) dailyPoints += 4;
                    if (inputs.cleanEating.noFastFood) dailyPoints += 4;
                    if (inputs.cleanEating.noFried) dailyPoints += 4;
                }

                monthlyScores[monthKey] += dailyPoints;

                // Agregar para metas semanais
                const weekIndex = getChallengeWeekIndex(logDate);
                if (weekIndex >= 0) {
                    if (!weeklyAggregates[weekIndex]) weeklyAggregates[weekIndex] = { aerobic: 0, strength: 0, endDate: null };
                    weeklyAggregates[weekIndex].aerobic += inputs.aerobicMinutes;
                    weeklyAggregates[weekIndex].strength += inputs.strengthSessions;
                    
                    const weekStart = new Date(challengeStartDate);
                    weekStart.setDate(weekStart.getDate() + (weekIndex * 7));
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6);
                    weeklyAggregates[weekIndex].endDate = weekEnd;
                }
            }

            // 2. Calcular Metas SEMANAIS e somar ao m√™s onde a semana TERMINA
            for (const wIndex in weeklyAggregates) {
                const weekData = weeklyAggregates[wIndex];
                const weekPoints = getAerobicScore(weekData.aerobic) + getStrengthScore(weekData.strength);
                
                const targetMonthKey = getMonthKey(weekData.endDate);
                
                if (!monthlyScores[targetMonthKey]) monthlyScores[targetMonthKey] = 0;
                monthlyScores[targetMonthKey] += weekPoints;
            }

            return monthlyScores;
        };

        const getCurrentMonthScore = (participantName) => {
            const today = new Date();
            const currentMonthKey = getMonthKey(today);
            const scores = calculateScoresByMonth(participantName);
            return scores[currentMonthKey] || 0;
        };
        
        // --- UI UPDATES ---
        
        const updateChart = () => {
            const ctx = document.getElementById('evolutionChart').getContext('2d');
            
            if (state.chartInstance) {
                state.chartInstance.destroy();
            }

            const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const datasets = participants.map((p, index) => {
                const scores = calculateScoresByMonth(p);
                const data = [];
                for (let m = 1; m <= 12; m++) {
                    const key = `2026-${String(m).padStart(2, '0')}`;
                    data.push(Math.round(scores[key] || 0));
                }
                return {
                    label: p,
                    data: data,
                    borderColor: participantColors[index],
                    backgroundColor: participantColors[index],
                    tension: 0.1,
                    fill: false
                };
            });

            state.chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Pontua√ß√£o Mensal por Participante' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Pontos' }
                        }
                    }
                }
            });
        };

        const updateMonthlyRankingUI = () => {
            const rankingData = participants.map(p => ({
                name: p,
                score: getCurrentMonthScore(p)
            })).sort((a, b) => b.score - a.score);

            const rankingList = document.getElementById('monthly-ranking-list');
            const leaderboardMain = document.getElementById('leaderboard');
            
            const htmlContent = rankingData.map((data, index) => {
                const medal = ['ü•á', 'ü•à', 'ü•â'][index] || `${index + 1}.`;
                return `<div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg border">
                    <div class="flex items-center"><span class="text-xl w-8">${medal}</span><span class="font-bold">${data.name}</span></div>
                    <div class="text-right"><span class="font-bold text-teal-600 text-lg">${Math.round(data.score)}</span> <span class="text-xs">pts</span></div>
                </div>`;
            }).join('');

            if(rankingList) rankingList.innerHTML = htmlContent;
            if(leaderboardMain) leaderboardMain.innerHTML = htmlContent;
        };

        // --- EXPORT & NAVIGATION ---
        const exportMonthlyReport = () => {
             const today = new Date();
             const currentMonthKey = getMonthKey(today);
             
             const dataForSheet = [
                 ["Relat√≥rio Mensal"], 
                 [`M√™s: ${currentMonthKey}`], 
                 [], 
                 ["Nome", "Data", "Min Aer√≥bico", "For√ßa (Sim/N√£o)", "Frutas(Qtd)", "Hidrata√ß√£o", "Sem Doces", "Sem Refri", "Sem FastFood", "Sem Fritura", "Sono", "Cuidado Pessoal"]
             ];

             participants.forEach(participant => {
                const participantData = state.allData[participant] || { dailyLogs: {} };
                const sortedDateKeys = Object.keys(participantData.dailyLogs).sort();
                for (const dateKey of sortedDateKeys) {
                    const logDate = new Date(dateKey + 'T12:00:00');
                    if (getMonthKey(logDate) === currentMonthKey) {
                        const inputs = participantData.dailyLogs[dateKey].inputs;
                        const ce = inputs.cleanEating || {};
                        dataForSheet.push([
                            participant, logDate.toLocaleDateString('pt-BR'),
                            inputs.aerobicMinutes, inputs.strengthSessions > 0 ? 'Sim' : 'N√£o', inputs.fruitPortions,
                            inputs.hydration ? 'Sim' : 'N√£o',
                            ce.noSweets ? 'Sim' : 'N√£o', ce.noSoda ? 'Sim' : 'N√£o', ce.noFastFood ? 'Sim' : 'N√£o', ce.noFried ? 'Sim' : 'N√£o',
                            inputs.sleep ? 'Sim' : 'N√£o', inputs.selfCareActivities.join(', ')
                        ]);
                    }
                }
             });
             
             const ws = XLSX.utils.aoa_to_sheet(dataForSheet); 
             const wb = XLSX.utils.book_new(); 
             XLSX.utils.book_append_sheet(wb, ws, "Dados do M√™s"); 
             XLSX.writeFile(wb, `relatorio_mensal_${currentMonthKey}.xls`);
        };
        
        const exportFullReport = () => {
            const dataForSheet = [["Relat√≥rio Geral 2026"], [], ["Nome", "Data", "Min Aer√≥bico", "For√ßa", "Frutas", "Hidrata√ß√£o", "Sono"]];
             participants.forEach(participant => {
                const participantData = state.allData[participant] || { dailyLogs: {} };
                for (const dateKey in participantData.dailyLogs) {
                    const inputs = participantData.dailyLogs[dateKey].inputs;
                    dataForSheet.push([participant, dateKey, inputs.aerobicMinutes, inputs.strengthSessions, inputs.fruitPortions, inputs.hydration ? 'S' : 'N', inputs.sleep ? 'S' : 'N']);
                }
             });
             const ws = XLSX.utils.aoa_to_sheet(dataForSheet); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Geral"); XLSX.writeFile(wb, `relatorio_geral.xls`);
        };

        // --- SETUP LOGIC ---
        const checkSetupValidity = () => {
            const dateVal = setupDate?.value;
            const participantVal = setupParticipant?.value;
            if (dateVal && participantVal) {
                const selectedDate = new Date(dateVal + 'T12:00:00');
                
                if (selectedDate < challengeStartDate || selectedDate > challengeEndDate) {
                    confirmBtn.disabled = true;
                    confirmDetails.classList.add('hidden');
                    alert("Data fora do per√≠odo (12/01 a 20/12/2026).");
                    setupDate.value = '';
                    return;
                }

                state.selectedDate = selectedDate;
                state.selectedParticipant = participantVal;
                confirmName.textContent = participantVal;
                confirmDate.textContent = selectedDate.toLocaleDateString('pt-BR');
                confirmDetails.classList.remove('hidden');
                confirmBtn.disabled = false;
            } else {
                confirmBtn.disabled = true;
                confirmDetails.classList.add('hidden');
            }
        };

        setupDate?.addEventListener('change', checkSetupValidity);
        setupParticipant?.addEventListener('change', checkSetupValidity);

        confirmBtn?.addEventListener('click', () => {
            setupScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            document.getElementById('current-participant-name').textContent = state.selectedParticipant;
            document.getElementById('current-checkin-date').textContent = state.selectedDate.toLocaleDateString('pt-BR');
            
            const dateKey = getFormattedDateKey(state.selectedDate);
            const participantLogs = state.allData[state.selectedParticipant]?.dailyLogs || {};
            
            resetFormVisuals();

            if (participantLogs[dateKey]) {
                showMessage('Editando registro existente.', 'info');
                prefillForm(participantLogs[dateKey].inputs);
            }
            updateMonthlyRankingUI(); 
        });

        // --- SUBMIT LOGIC ---
        checkinForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = document.getElementById('submit-checkin-btn');
            submitButton.disabled = true;
            submitButton.textContent = "Salvando...";
            
            const dateKey = getFormattedDateKey(state.selectedDate);
            
            const inputs = {
                aerobicMinutes: Number(document.getElementById('aerobic-minutes').value) || 0,
                strengthSessions: document.getElementById('strength-check').checked ? 1 : 0,
                fruitPortions: Number(document.getElementById('fruit-portions-input').value) || 0,
                hydration: document.getElementById('hydration').checked,
                cleanEating: {
                    noSweets: document.getElementById('clean-no-sweets').checked,
                    noSoda: document.getElementById('clean-no-soda').checked,
                    noFastFood: document.getElementById('clean-no-fastfood').checked,
                    noFried: document.getElementById('clean-no-fried').checked
                },
                sleep: document.getElementById('sleep').checked,
                selfCareActivities: Array.from(document.querySelectorAll('input[name="selfcare-activity"]:checked')).map(el => el.value)
            };

            try {
                const participantRef = doc(state.db, `artifacts/${state.appId}/public/data/healthChallenge`, state.selectedParticipant);
                const currentData = state.allData[state.selectedParticipant] || { dailyLogs: {} };
                currentData.dailyLogs[dateKey] = { inputs };
                
                state.allData[state.selectedParticipant] = currentData;
                
                await setDoc(participantRef, currentData);
                showMessage('Check-in salvo!', 'success');
                showSummary(inputs); 
            } catch (error) {
                console.error("Erro:", error);
                showMessage('Erro ao salvar.', 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = "Finalizar Check-in";
            }
        });

        const showSummary = (inputs) => {
             const { selectedParticipant, selectedDate } = state;
             const dailyTotal = getFruitScore(inputs.fruitPortions) + 
                                (inputs.hydration ? 15 : 0) + 
                                (inputs.sleep ? 10 : 0) +
                                getSelfCareScore(inputs.selfCareActivities) + 
                                (inputs.cleanEating.noSweets ? 4 : 0) +
                                (inputs.cleanEating.noSoda ? 4 : 0) +
                                (inputs.cleanEating.noFastFood ? 4 : 0) +
                                (inputs.cleanEating.noFried ? 4 : 0);

            const monthlyScore = getCurrentMonthScore(selectedParticipant);

            document.getElementById('summary-name').textContent = selectedParticipant;
            document.getElementById('summary-date').textContent = selectedDate.toLocaleDateString('pt-BR');
            document.getElementById('summary-daily-total').textContent = Math.round(dailyTotal);
            document.getElementById('summary-monthly-total').textContent = Math.round(monthlyScore);
            
            document.getElementById('summary-details').innerHTML = `
                <p>Check-in realizado com sucesso.</p>
                <p>Aer√≥bico: ${inputs.aerobicMinutes} min</p>
                <p>For√ßa: ${inputs.strengthSessions > 0 ? 'Feito' : 'N√£o feito'}</p>
            `;
            
            summaryModal.classList.remove('hidden');
        };

        // --- LISTENERS ---
        document.getElementById('chart-btn')?.addEventListener('click', () => { 
            updateChart(); 
            chartModal.classList.remove('hidden'); 
        });
        document.getElementById('close-chart-btn')?.addEventListener('click', () => chartModal.classList.add('hidden'));

        document.getElementById('monthly-ranking-btn')?.addEventListener('click', () => { 
            updateMonthlyRankingUI(); 
            monthlyRankingModal.classList.remove('hidden'); 
        });
        document.getElementById('monthly-report-btn')?.addEventListener('click', exportMonthlyReport);
        document.getElementById('full-report-btn')?.addEventListener('click', exportFullReport);
        document.getElementById('score-table-btn')?.addEventListener('click', () => { scoreTableModal.classList.remove('hidden'); });
        
        document.getElementById('close-score-table-btn')?.addEventListener('click', () => { scoreTableModal.classList.add('hidden'); });
        document.getElementById('close-monthly-ranking-btn')?.addEventListener('click', () => { monthlyRankingModal.classList.add('hidden'); });

        const goHome = () => {
            mainApp.classList.add('hidden');
            thankYouScreen.classList.add('hidden');
            setupScreen.classList.remove('hidden');
            setupDate.value = '';
            setupParticipant.value = '';
            confirmDetails.classList.add('hidden');
            confirmBtn.disabled = true;
        };

        document.getElementById('back-home-checkin-btn')?.addEventListener('click', goHome);
        document.getElementById('back-home-final-btn')?.addEventListener('click', goHome);

        document.getElementById('close-summary-btn')?.addEventListener('click', () => {
            summaryModal.classList.add('hidden');
            mainApp.classList.add('hidden');
            showMotivationalCard();
            populateScoreTableModal();
            thankYouScreen.classList.remove('hidden');
        });

        document.getElementById('add-another-checkin-btn')?.addEventListener('click', goHome);

        document.getElementById('export-png-btn')?.addEventListener('click', () => {
            const content = document.getElementById('summary-content');
            if(content) {
                html2canvas(content, { scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `resumo_saude.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                });
            }
        });

        // Initialize Firebase
        const init = async () => {
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyCzVuw8VwY2e0qr1DngYQdp4En5je4HmyI",
                    authDomain: "desafio-explorar-vizinhanca.firebaseapp.com",
                    projectId: "desafio-explorar-vizinhanca",
                    storageBucket: "desafio-explorar-vizinhanca.firebasestorage.app",
                    messagingSenderId: "535102451702",
                    appId: "1:535102451702:web:b626d741c44952c78da1d7"
                };

                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                state.db = getFirestore(app);
                
                await signInAnonymously(auth);

                const collectionRef = collection(state.db, `artifacts/${state.appId}/public/data/healthChallenge`);
                
                onSnapshot(collectionRef, (snapshot) => {
                    snapshot.docs.forEach(doc => {
                        state.allData[doc.id] = doc.data();
                    });
                    updateMonthlyRankingUI();
                });

                setupParticipant.innerHTML = '<option value="">-- Selecione --</option>' + participants.map(p => `<option value="${p}">${p}</option>`).join('');
                populateChecklists();
                populateScoreTableModal();
                setupSelectors(); 
                updateDayCounter();
                
                loadingScreen.classList.add('hidden');
                setupScreen.classList.remove('hidden');

            } catch (error) {
                console.error("Erro na inicializa√ß√£o:", error);
                loadingScreen.innerHTML = `<p class="text-red-500">Erro de conex√£o.</p>`;
            }
        };

        init();
    </script>
</body>
</html>